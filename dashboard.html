<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Vote It</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>

<body>
    <header>
        <div class="container nav-wrapper">
            <a href="dashboard.html" class="logo">
                <i class="fa-solid fa-square-poll-vertical"></i> Vote It
            </a>
            <nav class="nav-links">
                <a href="dashboard.html" class="nav-link active">Dashboard</a>
                <button id="themeBtn" onclick="toggleTheme()" class="btn btn-outline"
                    style="padding: 0.5rem; width: 40px; height: 40px; border-radius: 50%; margin-right: 1rem;">
                    <i class="fa-solid fa-sun"></i>
                </button>
                <div style="display: flex; align-items: center; gap: 1rem;">
                    <span id="userName" style="font-weight: 600;">User</span>
                    <button onclick="logout()" class="btn btn-outline" style="padding: 0.5rem 1rem; font-size: 0.9rem;">
                        <i class="fa-solid fa-right-from-bracket"></i>
                    </button>
                </div>
            </nav>
        </div>
    </header>

    <main class="container" style="padding: 2rem 1.5rem;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
            <h1 style="font-size: 2rem;">My Polls</h1>
            <a href="create.html" class="btn btn-primary">
                <i class="fa-solid fa-plus"></i> Create New Poll
            </a>
        </div>

        <!-- Stats -->
        <div
            style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem; margin-bottom: 3rem;">
            <div class="card" style="padding: 1.5rem;">
                <div style="color: var(--text-muted); font-size: 0.9rem; margin-bottom: 0.5rem;">Total Polls
                </div>
                <div id="totalPolls" style="font-size: 2rem; font-weight: 700;">0</div>
            </div>
            <div class="card" style="padding: 1.5rem;">
                <div style="color: var(--text-muted); font-size: 0.9rem; margin-bottom: 0.5rem;">Total Votes
                    Received
                </div>
                <div id="totalVotes" style="font-size: 2rem; font-weight: 700;">0</div>
            </div>
            <div class="card" style="padding: 1.5rem;">
                <div style="color: var(--text-muted); font-size: 0.9rem; margin-bottom: 0.5rem;">Active Polls
                </div>
                <div id="activePolls" style="font-size: 2rem; font-weight: 700; color: var(--success);">0</div>
            </div>
        </div>

        <!-- Polls Grid -->
        <div id="pollsGrid"
            style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 2rem;">
            <!-- Polls will be injected here -->
        </div>
    </main>

    <script src="script.js"></script>
    <script>
        // Auth Check
        const user = checkAuth();
        document.getElementById('userName').textContent = user.name;

        function logout() {
            localStorage.removeItem('user');
            window.location.href = 'index.html';
        }

        // Render Polls
        const polls = Store.getPolls();
        const grid = document.getElementById('pollsGrid');

        // Update Stats
        document.getElementById('totalPolls').textContent = polls.length;
        document.getElementById('totalVotes').textContent = polls.reduce((acc, p) => acc + p.totalVotes, 0);
        document.getElementById('activePolls').textContent = polls.filter(p => new Date(p.expiry) > new Date()).length;

        polls.forEach(poll => {
            const isActive = new Date(poll.expiry) > new Date();
            const statusColor = isActive ? 'var(--success)' : 'var(--text-muted)';
            const statusText = isActive ? 'Active' : 'Ended';

            let contentHtml = '';
            if (isActive) {
                contentHtml = `
                    <p style="color: var(--text-muted); margin-bottom: 1.5rem; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;">
                        ${poll.description}
                    </p>
                `;
            } else {
                // Generate results HTML
                const total = poll.totalVotes;
                contentHtml = '<div style="margin-bottom: 1.5rem;">';
                poll.options.forEach(opt => {
                    const pct = total === 0 ? 0 : Math.round((opt.votes / total) * 100);
                    contentHtml += `
                        <div style="margin-bottom: 0.5rem; font-size: 0.85rem;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 0.2rem;">
                                <span>${opt.text}</span>
                                <span>${pct}%</span>
                            </div>
                            <div style="height: 6px; background: var(--bg-input); border-radius: 3px; overflow: hidden;">
                                <div style="height: 100%; width: ${pct}%; background: var(--primary);"></div>
                            </div>
                        </div>
                    `;
                });
                contentHtml += '</div>';
            }

            const card = document.createElement('div');
            card.className = 'card poll-card';
            card.style.cursor = 'pointer';
            card.onclick = (e) => {
                window.location.href = `poll.html?id=${poll.id}`;
            };

            card.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1rem;">
                    <span style="background: ${statusColor}; color: white; padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.8rem; font-weight: 600;">${statusText}</span>
                    <div style="text-align: right;">
                        <div style="color: var(--text-muted); font-size: 0.9rem; margin-bottom: 0.25rem;">
                            <i class="fa-regular fa-clock"></i> ${formatDate(poll.expiry)}
                        </div>
                        <div style="font-family: monospace; font-size: 0.8rem; color: var(--primary); background: rgba(99, 102, 241, 0.1); padding: 2px 6px; border-radius: 4px; display: inline-block;">
                            ID: ${poll.id}
                        </div>
                    </div>
                </div>
                <h3 style="margin-bottom: 0.5rem; font-size: 1.25rem;">${poll.title}</h3>
                
                ${contentHtml}
                
                <div style="display: flex; justify-content: space-between; align-items: center; margin-top: auto;">
                    <span style="font-weight: 600; color: var(--primary);">
                        <i class="fa-solid fa-users"></i> ${poll.totalVotes} votes
                    </span>
                    <div style="display: flex; gap: 0.5rem;">
                        <button onclick="event.stopPropagation(); sharePoll('${poll.id}')" class="btn btn-outline" style="padding: 0.5rem; width: 36px; height: 36px;">
                            <i class="fa-solid fa-share-nodes"></i>
                        </button>
                        <button onclick="event.stopPropagation(); deletePoll('${poll.id}')" class="btn btn-outline" style="padding: 0.5rem; width: 36px; height: 36px; color: var(--danger); border-color: var(--danger);">
                            <i class="fa-solid fa-trash"></i>
                        </button>
                    </div>
                </div>
            `;
            grid.appendChild(card);
        });

        function sharePoll(id) {
            const url = window.location.origin + '/poll.html?id=' + id;
            navigator.clipboard.writeText(url).then(() => {
                alert('Link copied to clipboard: ' + url);
            });
        }

        function deletePoll(id) {
            if (confirm('Are you sure you want to delete this poll?')) {
                Store.deletePoll(id);
                window.location.reload();
            }
        }
    </script>
</body>

</html>